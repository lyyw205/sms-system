# SMS 자동 응답 + 예약 관리 + 웹 대시보드 구현 계획

## 개요
- **목표**: SMS 자동 응답(RAG+룰) + 네이버 예약 연동 + 종합 웹 대시보드
- **기술 스택**: Python FastAPI (백엔드) + React (프론트엔드) + 국내 SMS API + RAG
- **난이도**: **상** (기존 중상에서 상향 — 예약 연동, 대시보드 추가)

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────┐
│                 웹 대시보드 (React)                        │
│  예약관리 | SMS모니터링 | 검토대기큐 | 룰/문서관리 | 통계  │
└───────────────────────┬─────────────────────────────────┘
                        │ REST API + WebSocket (실시간 알림)
┌───────────────────────▼─────────────────────────────────┐
│                FastAPI 백엔드 서버                         │
│                                                          │
│  ┌──────────┐  ┌──────────┐  ┌───────────────────┐      │
│  │ SMS 모듈  │  │ 예약 모듈 │  │  RAG 파이프라인   │      │
│  │수신/발신  │  │네이버연동 │  │ ChromaDB + LLM   │      │
│  └─────┬────┘  └────┬─────┘  └────────┬──────────┘      │
│        │            │                  │                  │
│  ┌─────▼────────────▼──────────────────▼──────────────┐  │
│  │       메시지 라우터 (룰 → RAG fallback)             │  │
│  └──────────────────┬─────────────────────────────────┘  │
│                     │                                     │
│  ┌──────────────────▼─────────────────────────────────┐  │
│  │       Human-in-the-Loop 판정                        │  │
│  │  confidence ≥ 임계값 → 자동 발송                     │  │
│  │  confidence < 임계값 or 민감 키워드 → 검토 큐        │  │
│  └──────────────────┬─────────────────────────────────┘  │
│                     │                                     │
│  ┌──────────────────▼─────────────────────────────────┐  │
│  │  비동기 처리 (Celery + Redis / BackgroundTasks)      │  │
│  │  중복 수신 필터 → 태스크 큐 → 재시도 (지수 백오프)   │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │   DB (PostgreSQL) + Redis (큐/캐시) + Google Sheets │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
```

## 프로젝트 구조

```
sms-reservation-system/
├── backend/
│   ├── app/
│   │   ├── main.py                # FastAPI 엔트리포인트
│   │   ├── config.py              # 환경변수 설정
│   │   ├── api/
│   │   │   ├── webhooks.py        # SMS 수신 웹훅
│   │   │   ├── reservations.py    # 예약 관리 API
│   │   │   ├── messages.py        # SMS 이력 API
│   │   │   ├── rules.py           # 룰 관리 API
│   │   │   ├── documents.py       # RAG 문서 관리 API
│   │   │   └── dashboard.py       # 대시보드 통계 API
│   │   ├── sms/
│   │   │   ├── client.py          # SMS 발송 클라이언트
│   │   │   └── models.py          # SMS 데이터 모델
│   │   ├── reservation/
│   │   │   ├── naver_sync.py      # 네이버 예약 연동
│   │   │   ├── google_sheets.py   # Google Sheets 동기화
│   │   │   ├── notifier.py        # 예약 상태 변경 → SMS 알림
│   │   │   └── models.py          # 예약 데이터 모델
│   │   ├── router/
│   │   │   └── message_router.py  # 룰 vs RAG 분기
│   │   ├── rules/
│   │   │   ├── engine.py          # 룰 기반 응답 엔진
│   │   │   └── rules.yaml         # 기본 룰 정의
│   │   ├── rag/
│   │   │   ├── pipeline.py        # RAG 파이프라인
│   │   │   ├── embeddings.py      # 임베딩 처리
│   │   │   ├── vectorstore.py     # ChromaDB 연동
│   │   │   └── llm.py             # LLM 호출
│   │   └── db/
│   │       ├── database.py        # DB 연결 (SQLAlchemy)
│   │       └── models.py          # 전체 DB 모델
│   ├── documents/                 # RAG용 문서 저장소
│   ├── tests/
│   ├── alembic/                   # DB 마이그레이션
│   ├── .env
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── pages/
│   │   │   ├── Dashboard.tsx      # 메인 대시보드 (통계)
│   │   │   ├── Reservations.tsx   # 예약 관리 (목록/캘린더)
│   │   │   ├── Messages.tsx       # SMS 이력 조회
│   │   │   ├── Rules.tsx          # 응답 룰 관리
│   │   │   └── Documents.tsx      # RAG 문서 관리
│   │   ├── components/
│   │   └── App.tsx
│   ├── package.json
│   └── vite.config.ts
└── docker-compose.yml             # PostgreSQL, ChromaDB, Redis
```

## 구현 단계 (8단계)

### Phase 1: 기반 구축

#### 1단계: 프로젝트 초기 설정
- FastAPI 프로젝트 구조 생성
- PostgreSQL + SQLAlchemy + Alembic 설정
- Docker Compose (PostgreSQL, ChromaDB)
- `.env` 환경변수 구성
- DB 모델 정의 (예약, 메시지 이력, 룰)

#### 2단계: SMS 수신/발신 연동
- 국내 SMS API 클라이언트 구현 (NHN Cloud 또는 CoolSMS)
- 웹훅 엔드포인트 (수신 SMS → DB 저장)
- SMS 발신 기능 구현
- SMS 이력 저장

### Phase 2: 자동 응답 엔진

#### 3단계: 룰 기반 응답 엔진
- YAML 기반 룰 정의 (키워드, 정규식, 시간 조건 등)
- 룰 매칭 엔진 구현
- 룰 CRUD API

#### 4단계: RAG 파이프라인
- ChromaDB 벡터 스토어 설정
- 문서 로더 (PDF, TXT, XLSX)
- 임베딩 처리 (OpenAI 또는 HuggingFace)
- DB 데이터 → 벡터화 (예약 정보 등)
- LLM 연동 (Claude API) 응답 생성
- 메시지 라우터: 룰 우선 → RAG fallback

### Phase 3: 예약 연동

#### 5단계: 네이버 예약 연동
- 네이버 예약 API 또는 크롤링으로 예약 데이터 수집
- 예약 데이터 → 자체 DB 동기화 (주기적 polling)
- Google Sheets 양방향 동기화 (기존 워크플로우 유지)

#### 6단계: 예약 상태 변경 알림
- 예약 상태 변경 감지 (신규/확정/취소/변경)
- 상태별 SMS 알림 템플릿 관리
- 자동 SMS 발송 트리거

### Phase 4: 웹 대시보드

#### 7단계: 프론트엔드 기본 구조
- React + Vite + TypeScript 프로젝트 생성
- UI 프레임워크 (Ant Design 또는 shadcn/ui)
- 라우팅 + 레이아웃
- API 연동 레이어

#### 8단계: 대시보드 페이지 구현
- **메인 대시보드**: 오늘의 예약 현황, SMS 응답 통계, 최근 메시지
- **예약 관리**: 예약 목록 (테이블 + 캘린더 뷰), 상태 변경, 검색/필터
- **SMS 모니터링**: 자동 응답 이력, 응답 품질 확인, 수동 응답
- **룰 관리**: 응답 룰 추가/수정/삭제, 우선순위 설정
- **문서 관리**: RAG용 문서 업로드/삭제, 인덱싱 상태

## 주요 의존성

**백엔드:**
```
fastapi, uvicorn, sqlalchemy, alembic, asyncpg
langchain, chromadb, anthropic
httpx, pyyaml, python-dotenv
gspread (Google Sheets), apscheduler (스케줄링)
```

**프론트엔드:**
```
react, typescript, vite
ant-design (또는 shadcn/ui)
axios, react-router-dom
recharts (차트), dayjs
```

## 주요 리스크 및 고려사항

1. **네이버 예약 API**: 공식 API가 제한적 → 크롤링 또는 비공식 API 필요할 수 있음
2. **SMS 수신 웹훅**: 국내 SMS 서비스의 수신 웹훅 지원 확인 필요, 수신 전용 번호 발급 필요
3. **Google Sheets 동기화**: 기존 워크플로우와 충돌 없도록 동기화 전략 필요
4. **RAG 응답 품질**: 초기에는 룰 비중을 높이고 RAG는 점진적으로 확대 권장

## 검증 방법
1. **백엔드**: `pytest`로 각 모듈 단위 테스트
2. **SMS 연동**: `ngrok` + SMS API 웹훅으로 실제 문자 수신/발신 테스트
3. **RAG**: 문서 인덱싱 → 질문 → 관련 응답 생성 검증
4. **예약 연동**: 네이버 예약 변경 → DB 동기화 → SMS 알림 발송 확인
5. **대시보드**: 브라우저에서 각 페이지 기능 수동 테스트
6. **E2E**: 문자 수신 → 자동 응답 → 대시보드에서 이력 확인까지 전체 플로우
